# Difference-in-Differences Estimators {#did}


```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(gt)
```



```{r include=FALSE}
# the directory of documentation for chapter 1
dir_docs01 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
                   "Brumback FOCI Website Material", "Chapter 1")
dir_docs03 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
                   "Brumback FOCI Website Material", "Chapter 3")
dir_docs06 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
                   "Brumback FOCI Website Material", "Chapter 6")
# directory of data files
dir_data <- file.path(getwd(), "data")
# directory for functions
dir_lib <- file.path(getwd(), "lib")
```


```{r message=FALSE, warning=FALSE, include=FALSE}
source(file = file.path(dir_lib, "boot_utils.R"), 
       local = knitr::knit_global())
source(file = file.path(dir_lib, "gt_utils.R"), 
       local = knitr::knit_global())
source(file = file.path(dir_lib, "gt_measures.R"), 
       local = knitr::knit_global())
load(file.path(dir_docs01, "whatifdat.RData"))
load(file.path(dir_docs01, "doublewhatifdat.RData"))
load(file.path(dir_docs01, "gss.RData"))
load(file.path(dir_docs03, "brfss.RData"))
load(file.path(dir_docs06, "whatif2dat.RData"))
```


## Difference-in-Differences (DiD) Estimators


### DiD Estimator with a Linear Model

> The method relies on consistency as well as assumption A1:

$$
\begin{align*}
&E(Y_1(0) \mid A=1) - E(Y_1(0) \mid A=1) = \\
&E(Y_0(0) \mid A=1) - E(Y_0(0) \mid A=1)
\end{align*}
$$

That assumption is interpreted as : If assume that no treatment was applied in
"year" 1 (nothing happened in year 1) than we have the same results as in the 
base "year".


> also called **additive equi-confounding** [...]. The target of estimation is 
the linear ATT presented in chapter 6 as a risk difference

$$
\text{Linear ATT:} \: E(Y_1(1) - Y_1(0) \mid A=1)
$$
which is interpreted as *what is the the average difference between $Y_1(1)$ 
and $Y_1(0)$ if they all treated. For the example of the bank's NIM, what is
the average difference between the banks' NIM in NIRP ad non-NIRP economy assuming
they are all subjected to the NIRP policy, that is wihout the impact of the NIRP
policy.

and we have

$$
\begin{align*}
& E(Y_1(1) - Y_1(0)) \mid A=1) = \\
& E(Y_1(1) \mid A=1) - E(Y_1(0) \mid A=1) = \\
& [E(Y_1(1) \mid A=1) - E(Y_1(0) \mid A=1)] - [E(Y_1(0) \mid A=0) - E(Y_1(0) \mid A=0)] = \\
& [E(Y_1(1) \mid A=1) - E(Y_1(0) \mid A=0)] - [E(Y_1(0) \mid A=1) - E(Y_1(0) \mid A=0)] = \\
&\text{consistency assumption} \\
& [E(Y_1 \mid A=1) - E(Y_1 \mid A=0)] - [E(Y_1(0) \mid A=1) - E(Y_1(0) \mid A=0)] = \\
&\text{assumption A1, additive equi-confounding} \\
&\text{i.e. assuming that if nothing happens in year 1, then we can use the results of year 0} \\
& [E(Y_1 \mid A=1) - E(Y_1 \mid A=0)] - [E(Y_0 \mid A=1) - E(Y_0 \mid A=0)]
\end{align*}
$$

> we can therefore estimate the linear ATT via the difference in differences 
of averages

$$
\begin{align*}
&[\hat{E}(Y_1 \mid A=1) - \hat{E}(Y_1 \mid A=0)] - [\hat{E}(Y_0 \mid A=1) - \hat{E}(Y_0 \mid A=0)]= \\
&[\hat{E}(Y_1 \mid A=1) - \hat{E}(Y_0 \mid A=1)] - [\hat{E}(Y_1 \mid A=0) - \hat{E}(Y_0 \mid A=0)]= \\
&[\hat{E}(Y_1 - Y_0 \mid A=1)] - [\hat{E}(Y_1 - Y_0 \mid A=0)]
\end{align*}
$$

> We can also compute the DiD via the linear model

$$
E(Y_t \mid A) = \alpha_0 + \alpha_1 t + \alpha_2 A + \beta A * t
$$
and therefore


$$
\begin{align*}
\beta &= [E(Y_1 \mid A=1) - E(Y_0 \mid A=1)] - [E(Y_1 \mid A=0) - E(Y_0 \mid A=0)] \\
&= (\alpha_0 + \alpha_1 + \alpha_2 + \beta) - (\alpha_0 + \alpha_2) - 
((\alpha_0 + \alpha_2) - (\alpha_0))
\end{align*}
$$

> As we can estimate $E(Y(1) \mid A=1)$ directly via $E(Y_1 \mid A=1)$, we can 
also recover $E(Y(0) \mid A=1)$ via $E(Y_1 \mid A=1) - \beta$

because from above we have

$$
\begin{align*}
\beta &= E(Y_1(1) - Y_1(0)) \mid A=1) \\
&= E(Y_1(1) \mid A=1) - E(Y_1(0) \mid A=1) \\
&= E(Y_1 \mid A=1) - E(Y_1(0) \mid A=1) \\
&\therefore \\
E(Y_1(0) \mid A=1)& = E(Y_1 \mid A=1) - \beta
\end{align*}
$$

### DiD Estimator with a Loglinear Model

> The method relies on consistency as well as assumption A2:

$$
\begin{align*}
\frac{E(Y_1(0) \mid A=1)}{E(Y_1(0) \mid A=1)} =
\frac{E(Y_0(0) \mid A=1)}{E(Y_0(0) \mid A=1)}
\end{align*}
$$



### DiD Estimator with a Logistic Model

> The method relies on consistency as well as assumption A3:

$$
\begin{align*}
logit(E(Y_1(0) \mid A=1)) - logit(E(Y_1(0) \mid A=1)) =
logit(E(Y_0(0) \mid A=1)) - logit(E(Y_0(0) \mid A=1))
\end{align*}
$$


## Comparison with Standardization

The scripts of the functions are next

```{r echo=TRUE, file="lib\\fci_07-A_didlinear.R"}

```



### `doublewhatifdat`

The DiD estimator with the linear model

```{r}
dwhatif.lindid <- didlinear(doublewhatifdat, formula = Y ~ A, varsY = c("VL0", "VL1"), 
                           R = 100, conf = 0.95)
dwhatif.lindid
```



The DiD estimator with the loglinear model

```{r}
dwhatif.loglindid <- didloglinear(doublewhatifdat, formula = Y ~ A, varsY = c("VL0", "VL1"), 
                           R = 100, conf = 0.95)
dwhatif.loglindid
```


The DiD estimator with the logistic model

```{r}
dwhatif.logisticdid <- didlogistic(doublewhatifdat, formula = Y ~ A, varsY = c("VL0", "VL1"), 
                           R = 100, conf = 0.95)
dwhatif.logisticdid
```




verify the results

```{r}
bb_dwhatif <- data.frame(
  method = c("Linear","Loglinear", "Logistic", 
             "Linear","Loglinear", "Logistic",
             "Linear","Loglinear", "Logistic",
             "Linear","Loglinear", "Logistic"),
  name = c(
    "E(Y(0)|A=1)", "E(Y(0)|A=1)", "E(Y(0)|A=1)", 
    "RD", "RD", "RD",
    "RR", "RR", "RR", 
    "OR", "OR", "OR"),
  Truth = c(0.559, 0.559, 0.559, -0.36, -0.36, -0.36,
            0.356, 0.356, 0.356, 0.196, 0.196, 0.196),
  est = c(0.586, 0.577, 0.592, -0.355, -0.346, -0.362,
          0.394, 0.400, 0.390, 0.212, 0.22, 0.206),
  lci = c(0.508, 0.498, 0.513, -0.441, -0.431, -0.447, 
          0.309, 0.315, 0.306, 0.142, 0.149, 0.139),
  uci = c(0.664, 0.656, 0.671, -0.270, -0.262, -0.276,
          0.500, 0.508, 0.496, 0.315, 0.325, 0.307))
bb_dwhatif
```
```{r}
gt_measures_rowgrp(
    bb_dwhatif, 
    rowgroup = "name",
    rowname = "method",
    conf = 0.95,
    title = "Table 7.2", 
    subtitle = "Double What-If Study<br>Difference-in-Differences Estimation of the ATT"
  )
```

and the results from my own functions

```{r}
rbind(
  data.frame(
    method = "Linear",
    dwhatif.lindid), 
  data.frame(
    method = "Loglinear",
    dwhatif.loglindid),
  data.frame(
    method = "Logistic",
    dwhatif.logisticdid)) %>%
  gt_measures_rowgrp(
    rowgroup = "name",
    rowname = "method",
    conf = 0.95,
    title = "Table 7.2<em>(by FL)</em>", 
    subtitle = "Double What-If Study<br>Difference-in-Differences Estimation of the ATT"
  )
```

