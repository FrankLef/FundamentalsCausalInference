# Instrumental Variables {#instrument}


```{r echo=TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggdag)
library(patchwork)
library(ggplot2)
library(fciR)
options(dplyr.summarise.inform = FALSE)
```



```{r include=FALSE}
# directory of data files
dir_data <- file.path(getwd(), "data")
# directory for functions
dir_lib <- file.path(getwd(), "lib")
```



```{r echo=FALSE, warning=FALSE}
scm_9.1 <- list()
scm_9.1 <- within(scm_9.1, {
  coords <- list(
    x = c(`T` = 1, A = 2, U = 3, Y = 4),
    y = c(`T` = 1, A = 1, U = 2, Y = 1))
  dag <- dagify(
    A ~ `T` + U,
    Y ~ A + U,
    coords = coords)

  plot <- fciR::ggp_dag(dag)
})
```

```{r echo=FALSE, fig.align='center', fig.cap="Instrumental Variable for the Effect of A on Y", out.width="60%"}
scm_9.1$plot
```


> We enlist the following notation for this chapter. Let $Y(t,a)$ be the 
potential outcome for $Y$ assuming we set $T=t$ and then $A=a$.

* We assume consistency $E(Y(t) \mid T=t)= E(Y \mid T=t$)
* We assume exclusion $Y(t,a)=Y(a)$

Lets say that participants to treatment $T$ may comply or not and let $A$ be 
the treatment actually taken. That is $A=1$ means that the treatment was taken
by the participant. $A$ is therefore a post-randomization event.

When $A$ does not equal $T$ there is 2 historical methods:

1. *as-treated*: Compare $E(Y \mid A=1) with $E(Y \mid A=0)
2. *per-protocol*: We let $Z=1$ if $A=T$ and use ordinary stratification on
$Z=1$ to compare $E(Y \mid T=1, Z=1)$ with $E(Y \mid T=0, Z=1)$

$Z=1$ is not a randomization event since it uses observed measurements
after they occur. As a result $Z$ *cannot be expected to balance across 2 
treatments groups*. For example sicker patients could alwyas comply but healthy
ones might. In thsi case we have $T=1, A=1$ for the sicker patient but the healthy
patients would be a mix of $T=1, A-1$ and $T=1, A=0$.

> For these reasons, many studies rely on the *intent-to-treat effect* (ITT)
$E(Y \mid T=1) - E(Y \mid T=0)$. This equates to the causal effect

$$
ITT = E(Y(1,A(1))) -  E(Y, A(0, 0)))
$$


## Complier Average Causal Effect and Principal Stratification

### Principal Stratification

> Principal stratification classifies participants according to the potential 
occurence of a *post-randomization event*. We define 4 principal strata of 
participants according tottheir potential outcome $A(t)$.

1. *never-taker*: $A(0)=A(1)=0$. Will not take the treatment regardless of
randomized assignment.
2. *always-taker*: $A(0)=A(1)=1$. Will not take the treatment regardless of
randomized assignment.
3. *complier*: $A(0)=0, A(1)=1$, i.e. $A(t)=t$. Will take the treatment as 
required.
4. *defier*: $A(0)=1, A(1)=0$, i.e. $A(t)=1-t$. Will refuse to take the 
treatment as required.

Let $C$ indicate a complier, i.e. that $A(t)=t$. Then since

(a) $T$ is a randomized, i.e. $Y \perp\!\!\!\perp T \mid C$
(b) $C$ is a pre-randomization variable, i.e. $T \perp\!\!\!\perp C$
(c) $Y(t,a) = Y(a)$

it is reasonable to assume

$$
Y(a) \perp\!\!\!\perp T \mid C
$$

### Complier Average Causal Effect

The *complier average causal effect* (CACE) is defined as the average effect of 
treatment (ATT) in the compliers. That is

$$
\begin{align*}
CACE &= E(Y(1) \mid C=1) - E(Y(0) \mid C=1) \\
&= E(Y \mid T=1, C=1) - E(Y \mid T=0, C=1)
\end{align*}
$$


