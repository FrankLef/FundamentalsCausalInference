# Potential Outcomes and the Fundamental Problem of Causal Inference {#outcomes}

```{r echo=TRUE, message=FALSE, warning=FALSE}
# library(dplyr, quietly = TRUE)
# library(tidyr, quietly = TRUE)
# library(ggplot2, quietly = TRUE)
# library(gt, quietly = TRUE)
# library(boot, quietly = TRUE)
library(fciR)
```


```{r include=FALSE}
# the directory of documentation for chapter 1
# dir_docs01 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
#                    "Brumback FOCI Website Material", "Chapter 1")
# # the directory of documentation for chapter 3
# dir_docs03 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
#                    "Brumback FOCI Website Material", "Chapter 3")
# directory of data files
dir_data <- file.path(getwd(), "data")
# directory for functions
dir_lib <- file.path(getwd(), "lib")
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# source(file = file.path(dir_lib, "boot_utils.R"), 
#        local = knitr::knit_global())
# source(file = file.path(dir_lib, "gt_utils.R"), 
#        local = knitr::knit_global())
# source(file = file.path(dir_lib, "fci_03-A_bootu.R"), 
#        local = knitr::knit_global())
# source(file = file.path(dir_lib, "fci_03-B_bootc.R"), 
#        local = knitr::knit_global())
# source(file = file.path(dir_lib, "gt_measures.R"), 
#        local = knitr::knit_global())
# load(file.path(dir_docs01, "whatifdat.RData"))
# load(file.path(dir_docs01, "nces.RData"))
# load(file.path(dir_docs01, "gss.RData"))
# load(file.path(dir_docs03, "brfss.RData"))
```


## Potential Outcomes and the Consistency Assumption


## Circumventing the Fundamental Problem of Causal Inference


## Effect Measures

Run the function to get the association measures

```{r}
data("gss", package = "fciR")
gssrcc <- gss[, c("trump", "gthsedu", "magthsedu", "white", "female", "gt65")]
gssrcc <- gss[complete.cases(gssrcc), ]
stopifnot(nrow(gssrcc) == 2348 - 180)  # see comment on p. 46
```


```{r}
message("this takes 30 sec.: we load a saved file instead")
# startTime <- Sys.time()
# uncond <- fciR::meas_effect_uncond(dat = gssrcc, formula = trump ~ gthsedu)
# endTime <- Sys.time()
# print(endTime - startTime)
a_file <- file.path(dir_data, "chap03_bootu.rds")
# saveRDS(uncond, file = a_file)
uncond <- readRDS(file = a_file)
```



```{r}
gt_measures(uncond, 
            title = "Table 3.2", 
            subtitle = "4 Association Measures Relating<br><em>More than High School
            Education</em> to <em>Voting for Trump</em>")
```

verify with author's results, p. 48-49

```{r}
bb <- data.frame(
  name = c("p0", "p1", "rd", "rr", "rrstar", "or"),
  est = c(0.23338, 0.27117, 0.037782, 1.1619, 1.0518, 1.221),
  lci = c(0.21030, 0.24095, 0.00078085, 1.0047, 1.0006, 1.0056),
  uci = c(0.25647, 0.30139, 0.07478354, 1.3437, 1.1057, 1.4853))
stopifnot(
  all(abs(uncond$est - bb$est) < 0.01),
  all(abs(uncond$lci - bb$lci) < 0.015),
  all(abs(uncond$uci - bb$uci) < 0.02))
```



Now we estimate the four effect measures using *conditional* association
measures. We notice that

* The function used in chapter 3 on p. 50-52 is called `lmodboot.r()`. 
* The same name is used in chapter 2 on p.33-34 for a function computing only 
the estimand  (sampling distribution) but *not the association measures*

**We therefore rename the `lmodboot.r()` of chapter 3 as `bootc`** to

* show it relates to `bootu` with the `c` meaning **conditional** and
* avoid conflicting function names with `lmodboot.r()` of chapter 2



To use the function with conditioning on variables, i.e. filtering on variables,
we note that

$$
\begin{align*}
Y &= \text{trump} \\
T &= \text{gthsedu} \\
H_1 &= \text{magthsedu} \\
H_2 &= \text{white} \\
H_3 &= \text{female} \\
H_4 &= \text{gt65} \\
\end{align*}
$$

Therefore

$$
\begin{align*}
E(Y &\mid T = 0, H_1 = 1, H_2 = 1, H_3 = 1, H_4 = 1) \\
&\therefore \text{because T = 0} \\
Y &\sim H_1 + H_2 + H_3 + H_4 \\
\text{trump} &\sim \text{magthsedu} + \text{white} + \text{female} + \text{gt65} \\
\end{align*}
$$


```{r}
message("this takes 10 sec.: we load a saved file instead")
# startTime <- Sys.time()
# condit <- fciR::meas_effect_cond(dat = gssrcc,
#              formula = trump ~ gthsedu + magthsedu + white + female + gt65,
#              cond0 = trump ~ magthsedu + white + female + gt65,
#              cond1 = trump ~ gthsedu + magthsedu + white + female + gt65)
# endTime <- Sys.time()
# print(endTime - startTime)
a_file <- file.path(dir_data, "chap03_bootc.rds")
# saveRDS(condit, file = a_file)
condit <- readRDS(file = a_file)
```



```{r}
gt_measures(condit, 
            title = "Table 3.3", 
            subtitle = "4 Conditional Association or Effect Measures<br>
            Relating <em>More than High School Education</em> 
            to <em>Voting for Trump</em>")
```



verify with author's results, p.52

```{r}
bb <- data.frame(
  name = c("p0", "p1", "rd", "rr", "rrstar", "or"),
  est = c(0.25458, 0.30101, 0.046438, 1.1824, 1.0664, 1.261),
  lci = c(0.18518, 0.22995, 0.0022706, 1.0039, 1.0018, 1.0091),
  uci = c(0.32397, 0.37208, 0.0906057, 1.3927, 1.1352, 1.5758))
stopifnot(
  all(abs(condit$est - bb$est) < 0.01),
  all(abs(condit$lci - bb$lci) < 0.015),
  all(abs(condit$uci - bb$uci) < 0.02))
```


## Exercises

The exercises are located in a separate project.
