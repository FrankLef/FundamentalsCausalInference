# Backdoor Method via Standardization {#backdoor}


```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(dagitty)
library(ggplot2)
library(ggdag)
library(gt)
```



```{r include=FALSE}
# the directory of documentation for chapter 1
dir_docs01 <- file.path(dirname(getwd()), "FundamentalsCausalInference_docs",
                   "Brumback FOCI Website Material", "Chapter 1")
# directory of data files
dir_data <- file.path(getwd(), "data")
# directory for functions
dir_lib <- file.path(getwd(), "lib")
```


```{r message=FALSE, warning=FALSE, include=FALSE}
source(file = file.path(dir_lib, "boot_utils.R"), 
       local = knitr::knit_global())
source(file = file.path(dir_lib, "fci_06-A_bootstand.R"), 
       local = knitr::knit_global())
source(file = file.path(dir_lib, "fci_01-A_doublewhatifsim.R"), 
       local = knitr::knit_global())
source(file = file.path(dir_lib, "gt_measures.R"), 
       local = knitr::knit_global())
load(file.path(dir_docs01, "whatifdat.RData"))
```


## Standardization via Outome Modeling

> Standardization vis via outcome modelingis one way to estimate $E(Y(t))$


$$
\begin{align*}
&\text{by double expectation theorem} \\
E(Y(t)) &= E_H E(Y(t) \mid H) \\
&\text{by independence of T given H, (6.1)} \\
&= E_HE(Y(t) \mid T=t, H) \\
&\text{by consistency assumption} \\
&= E_HE(Y \mid T=t, H)
\end{align*}
$$

and with a binary dataset we can write

$$
\begin{align*}
E_H E(Y \mid T=t, H) = E(Y \mid T=t, H = 0) P(H = 0) + E(Y \mid T=t, H = 1) P(H = 1)
\end{align*}
$$


We use `R` to compute the standardized estimates with the following script


```{r eval=TRUE, echo=TRUE, file="lib\\fci_06-A_bootstand.R"}

```


**Example: What-if? Study**

and for the What-If? study this gives


```{r}
whatif.out <- bootstand(whatifdat, formula = Y ~ A + H + A*H)
```

and we compare with the author's

```{r}
comp <- data.frame(
  name = c("EY0", "EY1", "RD", "RR"),
  auth = c(0.375, 0.289, -0.086, 0.77),
  est = whatif.out$est
)
stopifnot(sum(abs(comp$auth - comp$est)) < 0.01)
```

and the results are presented in table 6.1

```{r}
t <- gt_measures(whatif.out, 
            title = "Table 6.1", 
            subtitle = "What-If Study: Standardized Estimates")
t
# a_file <- tempfile(fileext = ".png")
# gtsave(t, a_file)
# tpng <- png::readPNG(a_file, native = TRUE)
```

```{r}
df_lines <-
  data.frame(x = "EY0", xend = "EY1",
             y = whatif.out[whatif.out$name == "EY0", "est"],
             yend = whatif.out[whatif.out$name == "EY1", "est"])
df_points_Y <- data.frame(x = c("EY0", "EY1"),
                          label = c("Y0", "Y1"),
                          y = c(1 - mean(whatifdat$Y), mean(whatifdat$Y)))
df_lines_Y <-
  data.frame(x = "EY0", xend = "EY1",
             y = df_points_Y[df_points_Y$x == "EY0", "y"],
             yend = df_points_Y[df_points_Y$x == "EY1", "y"])
p <- whatif.out %>%
  filter(name %in% c("EY0", "EY1")) %>%
  ggplot(mapping = aes(x = as.factor(name), y = est, ymin = lci, ymax = uci)) +
  geom_linerange(size = 5, color = "gold") +
  geom_point(shape = 19, size = 4, color = "mediumblue") +
  geom_segment(df_lines, mapping = aes(x = x, xend = xend, y = y, yend = yend),
               inherit.aes = FALSE, color = "mediumblue") +
  geom_point(df_points_Y, mapping = aes(x = x, y = y), inherit.aes = FALSE,
             shape = 19, size = 4, color = "violetred") +
  geom_segment(df_lines_Y, mapping = aes(x = x, xend = xend, y = y, yend = yend),
               inherit.aes = FALSE, color = "violetred") +
  theme_minimal() +
  theme(title = element_text(color = "midnightblue"),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major  = element_blank(),
        panel.grid.minor  = element_blank(),
        plot.background = element_rect(fill = "gainsboro", color = "gainsboro"),
        plot.margin = unit(c(0, 0, 0, 0), "char"))
p
```



where we observe a reduction of the viral load but the difference is not
statistically significant.


**Example: Double What-if? Study**


```{r}
dataDoubleWhatIf <- doublewhatifsim()
```


```{r}
doublewhatif.out <- bootstand(dataDoubleWhatIf, formula = VL1 ~ A + AD0 + A*AD0)
```


```{r}
gt_measures(doublewhatif.out, 
            title = "Table 6.2", 
            subtitle = "What-If Study: Standardized Estimates")
```



> For comparisons, we repeat the standardization with $H = VL_0$



```{r}
doublewhatif.out <- bootstand(dataDoubleWhatIf, formula = VL1 ~ A + VL0 + A*VL0)
```


```{r}
gt_measures(doublewhatif.out, 
            title = "Table 6.3", 
            subtitle = "What-If Study: Standardized Estimates")
```


### Average Effect of Treatment on the Treated
